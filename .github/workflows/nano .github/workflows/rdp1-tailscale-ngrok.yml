name: RDP via Tailscale & ngrok (LXDE Desktop)

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:

      # 1ï¸âƒ£ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªØ«Ø¨ÙŠØª LXDE Ùˆxrdp
      - name: Install LXDE and xrdp
        run: |
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y lxde xrdp
          echo "lxsession -s LXDE -e LXDE" | sudo tee /etc/xrdp/startwm.sh > /dev/null
          sudo chmod +x /etc/xrdp/startwm.sh

      # 2ï¸âƒ£ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… RDP
      - name: Create RDP user
        env:
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          USERNAME="ahmed"   # â† ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø¥Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯Ù‡
          
          if id "$USERNAME" &>/dev/null; then
            echo "$USERNAME exists, skipping creation."
          else
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:${RDP_PASSWORD}" | sudo chpasswd
          fi

          sudo mkdir -p /home/${USERNAME}/.config
          echo "lxsession -s LXDE -e LXDE" | sudo tee /home/${USERNAME}/.xsession > /dev/null
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}

      # 3ï¸âƒ£ ØªØ´ØºÙŠÙ„ xrdp
      - name: Enable and start xrdp
        run: |
          sudo systemctl enable xrdp || true
          sudo systemctl restart xrdp || true
          sudo ss -tunlp | grep xrdp || true

      # 4ï¸âƒ£ ØªØ«Ø¨ÙŠØª Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo apt-key add -
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -y
          sudo apt-get install -y tailscale

      # 5ï¸âƒ£ ØªØ´ØºÙŠÙ„ Tailscale
      - name: Start and authenticate Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo tailscaled --tun=userspace-networking --socks5-server=localhost:1055 -state=/tmp/tailscaled.state &
          sleep 2
          sudo tailscale up --authkey="${TAILSCALE_AUTHKEY}" --hostname="github-rdp" --accept-routes=false || true
          sleep 3
          echo "Tailscale IPv4 addresses:"
          sudo tailscale ip -4 || true

      # 6ï¸âƒ£ ØªØ«Ø¨ÙŠØª ngrok
      - name: Install ngrok
        run: |
          curl -sSLo ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip
          unzip ngrok.zip
          chmod +x ngrok

      # 7ï¸âƒ£ ØªÙˆØ«ÙŠÙ‚ ngrok
      - name: Authenticate ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ./ngrok authtoken $NGROK_AUTH_TOKEN

      # 8ï¸âƒ£ ØªØ´ØºÙŠÙ„ ngrok Ø¹Ù„Ù‰ RDP
      - name: Start ngrok tunnel for RDP
        run: |
          ./ngrok tcp 3389 --log=stdout > ngrok.log &
          sleep 10
          cat ngrok.log | grep -Eo "tcp://[0-9a-zA-Z\.\-_:]+"

      # 9ï¸âƒ£ Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
      - name: Display connection info
        run: |
          echo "=============================================="
          echo "âœ… RDP is running with LXDE Desktop"
          echo ""
          echo "ğŸ”¹ Username: ahmed"
          echo "ğŸ”¹ Password: (from RDP_PASSWORD secret)"
          echo ""
          echo "You can connect via:"
          echo "  - Tailscale IP (from output above)"
          echo "  - ngrok TCP address (shown above)"
          echo "Example: tcp://0.tcp.ngrok.io:xxxxx"
          echo "=============================================="

      # ğŸ”Ÿ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù„Ø³Ø©
      - name: Keep session alive
        run: |
          echo "Keeping the RDP session alive for 2 hours..."
          sleep 7200

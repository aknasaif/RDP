name: RDP via Tailscale & ngrok (LXDE Desktop)

on:
  workflow_dispatch:

jobs:
  setup-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:

      # 1️⃣ تحديث النظام وتثبيت LXDE وxrdp
      - name: Install LXDE and xrdp
        run: |
          sudo apt-get update -y
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y lxde xrdp
          echo "lxsession -s LXDE -e LXDE" | sudo tee /etc/xrdp/startwm.sh > /dev/null
          sudo chmod +x /etc/xrdp/startwm.sh

      # 2️⃣ إنشاء مستخدم RDP
      - name: Create RDP user
        env:
          RDP_PASSWORD: ${{ secrets.RDP_PASSWORD }}
        run: |
          USERNAME="ahmed"   # ← غيّر هذا إلى اسم المستخدم الذي تريده
          
          if id "$USERNAME" &>/dev/null; then
            echo "$USERNAME exists, skipping creation."
          else
            sudo useradd -m -s /bin/bash "$USERNAME"
            echo "$USERNAME:${RDP_PASSWORD}" | sudo chpasswd
          fi

          sudo mkdir -p /home/${USERNAME}/.config
          echo "lxsession -s LXDE -e LXDE" | sudo tee /home/${USERNAME}/.xsession > /dev/null
          sudo chown -R ${USERNAME}:${USERNAME} /home/${USERNAME}

      # 3️⃣ تشغيل xrdp
      - name: Enable and start xrdp
        run: |
          sudo systemctl enable xrdp || true
          sudo systemctl restart xrdp || true
          sudo ss -tunlp | grep xrdp || true

      # 4️⃣ تثبيت Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.noarmor.gpg | sudo apt-key add -
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          sudo apt-get update -y
          sudo apt-get install -y tailscale

      # 5️⃣ تشغيل Tailscale
      - name: Start and authenticate Tailscale
        env:
          TAILSCALE_AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
        run: |
          sudo tailscaled --tun=userspace-networking --socks5-server=localhost:1055 -state=/tmp/tailscaled.state &
          sleep 2
          sudo tailscale up --authkey="${TAILSCALE_AUTHKEY}" --hostname="github-rdp" --accept-routes=false || true
          sleep 3
          echo "Tailscale IPv4 addresses:"
          sudo tailscale ip -4 || true

      # 6️⃣ تثبيت ngrok
      - name: Install ngrok
        run: |
          curl -sSLo ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.zip
          unzip ngrok.zip
          chmod +x ngrok

      # 7️⃣ توثيق ngrok
      - name: Authenticate ngrok
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          ./ngrok authtoken $NGROK_AUTH_TOKEN

      # 8️⃣ تشغيل ngrok على RDP
      - name: Start ngrok tunnel for RDP
        run: |
          ./ngrok tcp 3389 --log=stdout > ngrok.log &
          sleep 10
          cat ngrok.log | grep -Eo "tcp://[0-9a-zA-Z\.\-_:]+"

      # 9️⃣ عرض معلومات الاتصال
      - name: Display connection info
        run: |
          echo "=============================================="
          echo "✅ RDP is running with LXDE Desktop"
          echo ""
          echo "🔹 Username: ahmed"
          echo "🔹 Password: (from RDP_PASSWORD secret)"
          echo ""
          echo "You can connect via:"
          echo "  - Tailscale IP (from output above)"
          echo "  - ngrok TCP address (shown above)"
          echo "Example: tcp://0.tcp.ngrok.io:xxxxx"
          echo "=============================================="

      # 🔟 الحفاظ على الجلسة
      - name: Keep session alive
        run: |
          echo "Keeping the RDP session alive for 2 hours..."
          sleep 7200
